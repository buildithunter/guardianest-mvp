import { describe, it, expect, beforeEach, vi, Mock } from 'vitest';

// Mock OpenAI
vi.mock('openai', () => {
  return {
    default: vi.fn(() => ({
      chat: {
        completions: {
          create: vi.fn(),
        },
      },
    })),
  };
});\n\n// Mock fetch globally\nvi.mock('node:fetch', () => ({\n  fetch: vi.fn(),\n}));\n\nconst mockOpenAI = {\n  chat: {\n    completions: {\n      create: vi.fn(),\n    },\n  },\n};\n\nconst mockFetch = vi.fn();\n\ndescribe('Worker API', () => {\n  beforeEach(() => {\n    vi.clearAllMocks();\n    // Reset OpenAI mock\n    (mockOpenAI.chat.completions.create as Mock).mockReset();\n    // Reset fetch mock\n    mockFetch.mockReset();\n    global.fetch = mockFetch;\n  });\n\n  describe('Health Check', () => {\n    it('should return health status', async () => {\n      // Import the app after mocks are set up\n      const app = await import('../index');\n      \n      const response = await app.default.request('/health');\n      const data = await response.json();\n      \n      expect(response.status).toBe(200);\n      expect(data).toHaveProperty('ok', true);\n      expect(data).toHaveProperty('time');\n      expect(typeof data.time).toBe('string');\n    });\n  });\n\n  describe('AI Completion Endpoint', () => {\n    it('should handle homework help request', async () => {\n      // Mock OpenAI response\n      (mockOpenAI.chat.completions.create as Mock).mockResolvedValue({\n        choices: [{\n          message: {\n            content: \"Let's break down this math problem step by step. What do you think the first step should be?\"\n          }\n        }],\n        usage: {\n          prompt_tokens: 50,\n          completion_tokens: 30,\n          total_tokens: 80\n        }\n      });\n\n      const app = await import('../index');\n      \n      const response = await app.default.request('/ai/complete', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify({\n          text: 'What is 15 x 12?',\n          type: 'homework',\n          childAge: 10\n        })\n      });\n      \n      const data = await response.json();\n      \n      expect(response.status).toBe(200);\n      expect(data.success).toBe(true);\n      expect(data.data).toHaveProperty('response');\n      expect(data.data).toHaveProperty('usage');\n      expect(data.data.response).toContain('step by step');\n    });\n\n    it('should handle bedtime story request', async () => {\n      // Mock OpenAI response\n      (mockOpenAI.chat.completions.create as Mock).mockResolvedValue({\n        choices: [{\n          message: {\n            content: \"Once upon a time, there was a brave little robot who loved to help others...\"\n          }\n        }],\n        usage: {\n          prompt_tokens: 45,\n          completion_tokens: 60,\n          total_tokens: 105\n        }\n      });\n\n      const app = await import('../index');\n      \n      const response = await app.default.request('/ai/complete', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify({\n          text: 'Tell me a story about a robot',\n          type: 'story',\n          childAge: 7\n        })\n      });\n      \n      const data = await response.json();\n      \n      expect(response.status).toBe(200);\n      expect(data.success).toBe(true);\n      expect(data.data).toHaveProperty('response');\n      expect(data.data.response).toContain('robot');\n    });\n\n    it('should validate request body', async () => {\n      const app = await import('../index');\n      \n      const response = await app.default.request('/ai/complete', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify({\n          text: '', // Invalid: empty text\n          type: 'homework'\n        })\n      });\n      \n      expect(response.status).toBe(400);\n    });\n\n    it('should handle OpenAI API errors', async () => {\n      // Mock OpenAI error\n      (mockOpenAI.chat.completions.create as Mock).mockRejectedValue(\n        new Error('OpenAI API rate limit exceeded')\n      );\n\n      const app = await import('../index');\n      \n      const response = await app.default.request('/ai/complete', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify({\n          text: 'What is 2 + 2?',\n          type: 'homework',\n          childAge: 8\n        })\n      });\n      \n      const data = await response.json();\n      \n      expect(response.status).toBe(500);\n      expect(data.success).toBe(false);\n      expect(data).toHaveProperty('error');\n    });\n  });\n\n  describe('OCR Endpoint', () => {\n    it('should extract text from image', async () => {\n      // Mock Google Cloud Vision API response\n      mockFetch.mockResolvedValue({\n        ok: true,\n        json: () => Promise.resolve({\n          responses: [{\n            textAnnotations: [{\n              description: 'What is 5 + 3?',\n              confidence: 0.95\n            }]\n          }]\n        })\n      });\n\n      const app = await import('../index');\n      \n      const response = await app.default.request('/ocr/extract', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify({\n          image: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg=='\n        })\n      });\n      \n      const data = await response.json();\n      \n      expect(response.status).toBe(200);\n      expect(data.success).toBe(true);\n      expect(data.data).toHaveProperty('text', 'What is 5 + 3?');\n      expect(data.data).toHaveProperty('confidence', 95);\n    });\n\n    it('should handle missing Google Cloud API key', async () => {\n      const app = await import('../index');\n      \n      // Mock missing API key\n      const response = await app.default.request('/ocr/extract', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify({\n          image: 'data:image/png;base64,test'\n        })\n      });\n      \n      const data = await response.json();\n      \n      expect(response.status).toBe(503);\n      expect(data.success).toBe(false);\n      expect(data.error).toBe('OCR service not configured');\n    });\n\n    it('should validate image format', async () => {\n      const app = await import('../index');\n      \n      const response = await app.default.request('/ocr/extract', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify({\n          image: '' // Invalid: empty image\n        })\n      });\n      \n      expect(response.status).toBe(400);\n    });\n  });\n\n  describe('404 Handling', () => {\n    it('should return 404 for unknown endpoints', async () => {\n      const app = await import('../index');\n      \n      const response = await app.default.request('/unknown-endpoint');\n      \n      expect(response.status).toBe(404);\n      const data = await response.json();\n      expect(data.success).toBe(false);\n      expect(data.error).toBe('Endpoint not found');\n    });\n  });\n});
